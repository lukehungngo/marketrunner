<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC-USD Price Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>BTC-USD Price Forecast</h1>
<p>Below is the forecasted price chart:</p>

<!-- Date selection form -->
<label for="fromDate">From:</label>
<input type="date" id="fromDate" name="fromDate" value="2014-10-01">

<label for="toDate">To:</label>
<input type="date" id="toDate" name="toDate" value="{{ default_to_date }}"> <!-- default to current date -->

<button id="updateChart">Update Chart</button>
<script>
    document.getElementById('updateChart').addEventListener('click', function () {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;

        // Send the data to the Django view via AJAX (using fetch)
        fetch('/forecast-hl/update', {
            method: 'POST',  // Use POST for sending data
            headers: {
                'Content-Type': 'application/json',  // Ensure JSON is sent
                'X-CSRFToken': '{{ csrf_token }}'  // CSRF token for Django's protection
            },
            body: JSON.stringify({
                from_date: fromDate,
                to_date: toDate
            })
        })
            .then(response => response.json())
            .then(data => {
                const {dates, values, highValues, lowValues} = data;

                // Clear the existing chart and re-render it with the new data
                document.getElementById('forecastChart').remove(); // Remove the old canvas
                const newCanvas = document.createElement('canvas'); // Create a new canvas
                newCanvas.setAttribute('id', 'forecastChart');
                newCanvas.setAttribute('width', '800');
                newCanvas.setAttribute('height', '400');
                document.body.insertBefore(newCanvas, document.getElementById('updateChart').nextSibling);

                // Render the chart again with the new data from the server
                renderChart(dates, values, highValues, lowValues);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });
</script>

<!-- Create a canvas element where the chart will be rendered -->
<canvas id="forecastChart" width="800" height="400"></canvas>

<!-- Script to render the chart using Chart.js -->
<script>
    // Get the current date as default
    const currentDate = new Date().toISOString().split('T')[0];  // Get current date in YYYY-MM-DD format
    document.getElementById('toDate').value = currentDate;

    // Get the data passed from the Django view directly as arrays
    const dates = {{ dates|safe }};  // This outputs a valid JS array
    const values = {{ values|safe }};  // This outputs a valid JS array
    const highValues = {{ highValues|safe }};  // This outputs a valid JS array
    const lowValues = {{ lowValues|safe }};  // This outputs a valid JS array

    // Initial Chart Rendering
    function renderChart(filteredDates, filteredValues, filteredHighValues, filteredLowValues) {
        const ctx = document.getElementById('forecastChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: filteredDates,
                datasets: [
                    {
                        label: 'Price',
                        data: filteredValues,
                        borderColor: 'blue',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: 'blue'
                    },
                    {
                        label: 'TimeGPT-hi-90 (Upper Bound)',
                        data: filteredHighValues,
                        borderColor: 'green',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5],  // Make the line dashed for upper bound
                        pointRadius: 0,
                    },
                    {
                        label: 'TimeGPT-lo-90 (Lower Bound)',
                        data: filteredLowValues,
                        borderColor: 'red',
                        fill: false,
                        tension: 0.1,
                        borderDash: [5, 5],  // Make the line dashed for lower bound
                        pointRadius: 0,
                    },
                ]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'TimeGPT Forecast Value'
                        }
                    }
                }
            }
        });
    }

    // Filter the data based on the date range
    function filterDataByDate(fromDate, toDate) {
        const filteredDates = [];
        const filteredValues = [];
        const filteredHighValues = [];
        const filteredLowValues = [];

        dates.forEach((date, index) => {
            if (date >= fromDate && date <= toDate) {
                filteredDates.push(date);
                filteredValues.push(values[index]);
                filteredHighValues.push(highValues[index]);
                filteredLowValues.push(lowValues[index]);
            }
        });
        return {filteredDates, filteredValues, filteredHighValues, filteredLowValues};
    }

    // Initial rendering with full data
    renderChart(dates, values, highValues, lowValues);

    // Add event listener to the button
    document.getElementById('updateChart').addEventListener('click', function () {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;

        // Filter data based on selected dates
        const {filteredDates, filteredValues, filteredHighValues, filteredLowValues} = filterDataByDate(fromDate, toDate);

        // Clear the existing chart and re-render it
        document.getElementById('forecastChart').remove(); // Remove the old canvas
        const newCanvas = document.createElement('canvas'); // Create a new canvas
        newCanvas.setAttribute('id', 'forecastChart');
        newCanvas.setAttribute('width', '800');
        newCanvas.setAttribute('height', '400');
        document.body.insertBefore(newCanvas, document.getElementById('updateChart').nextSibling);

        // Render the chart again with filtered data
        renderChart(filteredDates, filteredValues, filteredHighValues, filteredLowValues);
    });
</script>
</body>
</html>
